<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>diskload: /home/jim/projects/geophysics/diskload/src/diskload.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">diskload
   </div>
   <div id="projectbrief">compute the elastic response to a disk load</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">/home/jim/projects/geophysics/diskload/src/diskload.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>Load Love numbers from an external ASCII file. Read Love numbers from <code>filename</code> assuming that each line includes four numbers (an integer index, followed by the three Love numbers h, l, k). Allocate storage space for a LoveNumber.</p>
<p><code>LoveNumbers* ln = read_love_numbers("REF_6371_loading_love_numbers_0_40000.txt");</code></p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">filename</td><td>the text filename to read</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>A newly allocated <a class="el" href="structLoveNumbers.html" title="elastic loading Love numbers ">LoveNumbers</a> struct, or NULL on error.</dd></dl>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;gsl/gsl_sf_hyperg.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;gsl/gsl_integration.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;gsl/gsl_sf_gamma.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;gsl/gsl_monte.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;gsl/gsl_monte_vegas.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;math.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;time.h&gt;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="diskload_8h.html">diskload.h</a>&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> <a name="_a0"></a><a class="code" href="structEarthModel.html">EarthModel</a> <a name="a1"></a><a class="code" href="structEarthModel.html#aa08f8ce5cd4ceb40465ce8f25a2c5350">DefaultEarthModel</a> = { 6371.0, 9.8046961 };</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a2"></a><a class="code" href="diskload_8h.html#aa22b5340dd8835736e744a1b9761b320">sphericaldiskload</a>(<span class="keywordtype">double</span> alpha,<a class="code" href="diskload_8h.html#a40ce0e491e7dccfd79fcc0b685c80a4b">DiskLoadType</a> icomp,<span class="keywordtype">double</span> theta,<span class="keywordtype">double</span> w,<span class="keywordtype">int</span> nmax,<a name="_a3"></a><a class="code" href="structLoveNumbers.html">LoveNumbers</a>* LN,<a class="code" href="structEarthModel.html">EarthModel</a>* EM, <span class="keywordtype">double</span> *u, <span class="keywordtype">double</span> *v, <span class="keywordtype">double</span> *g) {</div><div class="line">  <span class="keywordflow">return</span> 17;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/****************************************************************/</span></div><div class="line"><span class="comment">/* Load the love numbers */</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define LOVE_COUNT 40001</span></div><div class="line"><span class="keywordtype">double</span> h[LOVE_COUNT];</div><div class="line"><span class="keywordtype">double</span> l[LOVE_COUNT];</div><div class="line"><span class="keywordtype">double</span> k[LOVE_COUNT];</div><div class="line"></div><div class="line"><span class="keywordtype">char</span>* replace_char(<span class="keywordtype">char</span>* str, <span class="keywordtype">char</span> find, <span class="keywordtype">char</span> replace) {</div><div class="line">    <span class="keywordtype">char</span> *current_pos = strchr(str,find);</div><div class="line">    <span class="keywordflow">while</span> (current_pos){</div><div class="line">        *current_pos = replace;</div><div class="line">        current_pos = strchr(current_pos,find);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> str;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> load_love_numbers(<span class="keywordtype">void</span>) {</div><div class="line">  FILE* f = fopen(<span class="stringliteral">&quot;REF_6371_loading_love_numbers_0_40000.txt&quot;</span>, <span class="stringliteral">&quot;r&quot;</span>);</div><div class="line">  <span class="keywordtype">double</span> x, y, z;</div><div class="line">  <span class="keywordtype">int</span> n;</div><div class="line">  </div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">size_t</span> line_size = 300;</div><div class="line">  <span class="keywordtype">char</span>* line = alloca(line_size);</div><div class="line">  </div><div class="line">  <span class="keywordflow">while</span> (fgets(line, line_size, f) != NULL)  {</div><div class="line">    replace_char( line, <span class="charliteral">&#39;D&#39;</span>, <span class="charliteral">&#39;E&#39;</span> );</div><div class="line">    sscanf( line, <span class="stringliteral">&quot;%d %lf %lf %lf\n&quot;</span>, &amp;n, &amp;x, &amp;y, &amp;z );</div><div class="line">    h[n] = x;</div><div class="line">    l[n] = y;</div><div class="line">    k[n] = z;</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line"><a class="code" href="structLoveNumbers.html">LoveNumbers</a>* read_love_numbers(<span class="keywordtype">char</span>* filename) {</div><div class="line">  FILE* f = fopen(filename, <span class="stringliteral">&quot;r&quot;</span>);</div><div class="line"></div><div class="line">  <span class="keywordflow">if</span> (ferror(f)) {</div><div class="line">    <span class="keywordflow">return</span> NULL;</div><div class="line">  }</div><div class="line">  </div><div class="line">  <a class="code" href="structLoveNumbers.html">LoveNumbers</a>* result = malloc(<span class="keyword">sizeof</span>(<a class="code" href="structLoveNumbers.html">LoveNumbers</a>));</div><div class="line">  <span class="keywordflow">if</span> (result == NULL)</div><div class="line">    <span class="keywordflow">return</span> NULL;</div><div class="line">  </div><div class="line">  result-&gt;<a name="a4"></a><a class="code" href="structLoveNumbers.html#aa8229c678faf51a2fc7c7d5dcd5d56bd">degrees</a> = 0;</div><div class="line">  result-&gt;<a name="a5"></a><a class="code" href="structLoveNumbers.html#a8453f5a9ea53bb25696b30c98580a6c7">h</a> = NULL;</div><div class="line">  result-&gt;<a name="a6"></a><a class="code" href="structLoveNumbers.html#a725db92098c832cd3bcaa48e3e81b673">l</a> = NULL;</div><div class="line">  result-&gt;<a name="a7"></a><a class="code" href="structLoveNumbers.html#aa731916defdabf808ebe507e2baaa3f0">k</a> = NULL; </div><div class="line">  <span class="keywordtype">int</span> allocated_size = 0;</div><div class="line">  </div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">size_t</span> line_size = 255;</div><div class="line">  <span class="keywordtype">char</span>* line = alloca(line_size);</div><div class="line"></div><div class="line">  <span class="keywordtype">double</span> x, y, z;</div><div class="line">  <span class="keywordtype">int</span> n;</div><div class="line"></div><div class="line">  <span class="comment">// Loop over each line in the REF text file</span></div><div class="line">  <span class="keywordflow">while</span> (fgets(line, line_size, f) != NULL)  {</div><div class="line">    replace_char( line, <span class="charliteral">&#39;D&#39;</span>, <span class="charliteral">&#39;E&#39;</span> );</div><div class="line">    <span class="keywordflow">if</span> (sscanf( line, <span class="stringliteral">&quot;%d %lf %lf %lf\n&quot;</span>, &amp;n, &amp;x, &amp;y, &amp;z ) == 4) {</div><div class="line"></div><div class="line">      <span class="comment">// Grow our arrays to a larger size if needed</span></div><div class="line">      <span class="keywordflow">if</span> (n &gt;= allocated_size) {</div><div class="line">        allocated_size = allocated_size * 2 + 1;</div><div class="line">        result-&gt;<a class="code" href="structLoveNumbers.html#a8453f5a9ea53bb25696b30c98580a6c7">h</a> = realloc( result-&gt;<a class="code" href="structLoveNumbers.html#a8453f5a9ea53bb25696b30c98580a6c7">h</a>, allocated_size * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) );</div><div class="line">        result-&gt;<a class="code" href="structLoveNumbers.html#a725db92098c832cd3bcaa48e3e81b673">l</a> = realloc( result-&gt;<a class="code" href="structLoveNumbers.html#a725db92098c832cd3bcaa48e3e81b673">l</a>, allocated_size * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) );</div><div class="line">        result-&gt;<a class="code" href="structLoveNumbers.html#aa731916defdabf808ebe507e2baaa3f0">k</a> = realloc( result-&gt;<a class="code" href="structLoveNumbers.html#aa731916defdabf808ebe507e2baaa3f0">k</a>, allocated_size * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>) );</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> ((result-&gt;<a class="code" href="structLoveNumbers.html#a8453f5a9ea53bb25696b30c98580a6c7">h</a> == NULL) || (result-&gt;<a class="code" href="structLoveNumbers.html#a725db92098c832cd3bcaa48e3e81b673">l</a> == NULL) || (result-&gt;<a class="code" href="structLoveNumbers.html#aa731916defdabf808ebe507e2baaa3f0">k</a> == NULL)) {</div><div class="line">          <span class="comment">// BADBAD: we leak some memory in this error</span></div><div class="line">          <span class="keywordflow">return</span> NULL;</div><div class="line">        }</div><div class="line">      }</div><div class="line"></div><div class="line">      <span class="comment">// Store this line in the struct</span></div><div class="line">      result-&gt;<a class="code" href="structLoveNumbers.html#a8453f5a9ea53bb25696b30c98580a6c7">h</a>[n] = x;</div><div class="line">      result-&gt;<a class="code" href="structLoveNumbers.html#a725db92098c832cd3bcaa48e3e81b673">l</a>[n] = y;</div><div class="line">      result-&gt;<a class="code" href="structLoveNumbers.html#aa731916defdabf808ebe507e2baaa3f0">k</a>[n] = z;</div><div class="line">      <span class="keywordflow">if</span> (n + 1 &gt; result-&gt;<a class="code" href="structLoveNumbers.html#aa8229c678faf51a2fc7c7d5dcd5d56bd">degrees</a>)</div><div class="line">        result-&gt;<a class="code" href="structLoveNumbers.html#aa8229c678faf51a2fc7c7d5dcd5d56bd">degrees</a> = n + 1;</div><div class="line">    }</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> result;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/****************************************************************/</span></div><div class="line"><span class="comment">/* Naive version of Uu */</span></div><div class="line"></div><div class="line"><span class="keywordtype">double</span> uu_plain(<span class="keywordtype">double</span> alpha, <span class="keywordtype">double</span> theta) {</div><div class="line">  <span class="keywordtype">double</span> x = cos(theta);</div><div class="line">  <span class="keywordtype">double</span> y = cos(alpha);</div><div class="line">    </div><div class="line">  <span class="keywordtype">double</span> p0 = 1;</div><div class="line">  <span class="keywordtype">double</span> p1 = x;</div><div class="line"> </div><div class="line">  <span class="keywordtype">double</span> pp0 = 1;</div><div class="line">  <span class="keywordtype">double</span> pp1 = y;</div><div class="line">  <span class="keywordtype">double</span> q0 = 1-y;</div><div class="line">  </div><div class="line">  <span class="keywordtype">double</span> result = h[0] * q0 * p0;</div><div class="line">  </div><div class="line">  <span class="keywordtype">double</span> pp2, q1, p2;</div><div class="line">  </div><div class="line">  <span class="keywordflow">for</span>( <span class="keywordtype">int</span> n = 1; n &lt; 4000000; n++ ) {</div><div class="line">    pp2 = ((2*n+1)*y*pp1 - n*pp0)/(n+1);</div><div class="line">    q1 = (pp0 - pp2)/(2*n+1);</div><div class="line">    pp0 = pp1;</div><div class="line">    pp1 = pp2;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (n &lt;= 40000)</div><div class="line">      result = result + h[n] * q1 * p1;</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">      result = result + h[40000] * q1 * p1;</div><div class="line"></div><div class="line">    <span class="comment">//printf(&quot;%d %e\n&quot;, n, result);</span></div><div class="line">    </div><div class="line">    p2 = ((2*n+1)*x*p1 - n*p0)/(n+1);</div><div class="line">    p0 = p1;</div><div class="line">    p1 = p2;</div><div class="line">  }</div><div class="line">  </div><div class="line">  <span class="keywordflow">return</span> result;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">double</span></div><div class="line">spherical_integrand (<span class="keywordtype">double</span> *k, <span class="keywordtype">size_t</span> dim, <span class="keywordtype">void</span> *params)</div><div class="line">{</div><div class="line">  (void)(dim);</div><div class="line">  <span class="keywordtype">double</span> phi = k[0];</div><div class="line">  <span class="keywordtype">double</span> theta = k[1];</div><div class="line">  <span class="keywordtype">double</span> tr = ((<span class="keywordtype">double</span>*)params)[0];</div><div class="line">  <span class="keywordtype">double</span> result = (sin(theta)/(4.0 * M_PI)) * ( sqrt(2.0/(1.0-sin(theta)*cos(phi)*sin(tr) - cos(theta)*cos(tr))) );</div><div class="line">  <span class="keywordflow">return</span> result;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">double</span> spherical_core( <span class="keywordtype">double</span> alpha, <span class="keywordtype">double</span> tr ) {</div><div class="line">  gsl_monte_function G = { &amp;spherical_integrand, 2, &amp;tr };</div><div class="line">  </div><div class="line">  gsl_monte_vegas_state *s = gsl_monte_vegas_alloc ( 2 );</div><div class="line"></div><div class="line">  <span class="keywordtype">double</span> xl[2] = { 0, 0 };</div><div class="line">  <span class="keywordtype">double</span> xu[2] = { 2*M_PI, alpha };</div><div class="line">  </div><div class="line">  <span class="keyword">const</span> gsl_rng_type *T;</div><div class="line">  gsl_rng *r;</div><div class="line"></div><div class="line">  <span class="keywordtype">size_t</span> calls = 10000;</div><div class="line"></div><div class="line">  gsl_rng_env_setup ();</div><div class="line"></div><div class="line">  T = gsl_rng_default;</div><div class="line">  r = gsl_rng_alloc (T);</div><div class="line">  </div><div class="line">  <span class="keywordtype">double</span> res, err;</div><div class="line">    </div><div class="line">  <span class="comment">//gsl_monte_vegas_integrate (&amp;G, xl, xu, 2, 10000, r, s, &amp;res, &amp;err);</span></div><div class="line">  gsl_monte_vegas_integrate (&amp;G, xl, xu, 2, calls, r, s, &amp;res, &amp;err);</div><div class="line"></div><div class="line">  <span class="comment">/*</span></div><div class="line"><span class="comment">  do</span></div><div class="line"><span class="comment">  {</span></div><div class="line"><span class="comment">    gsl_monte_vegas_integrate (&amp;G, xl, xu, 2, calls/5, r, s, &amp;res, &amp;err);</span></div><div class="line"><span class="comment">    printf (&quot;result = % .6f sigma = % .6f &quot;</span></div><div class="line"><span class="comment">    &quot;chisq/dof = %.1f\n&quot;, res, err, gsl_monte_vegas_chisq (s));</span></div><div class="line"><span class="comment">    </span></div><div class="line"><span class="comment">    </span></div><div class="line"><span class="comment">  }</span></div><div class="line"><span class="comment">  while (fabs (gsl_monte_vegas_chisq (s) - 1.0) &gt; 0.5);</span></div><div class="line"><span class="comment">  */</span></div><div class="line">  <span class="comment">//printf (&quot;vegas final error = %.6f\n&quot;, err);</span></div><div class="line">  <span class="comment">//printf( &quot;error = %g\n&quot;, err );</span></div><div class="line">  </div><div class="line">  gsl_monte_vegas_free (s);</div><div class="line">  gsl_rng_free (r);</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> res;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">double</span> uu_spherical(<span class="keywordtype">double</span> alpha, <span class="keywordtype">double</span> theta) {</div><div class="line">  <span class="keywordtype">double</span> x = cos(theta);</div><div class="line">  <span class="keywordtype">double</span> y = cos(alpha);</div><div class="line"><span class="preprocessor">#define N 40000</span></div><div class="line">  <span class="keywordtype">double</span> core = h[N] * spherical_core(alpha,theta);</div><div class="line"></div><div class="line">  <span class="keywordtype">double</span> p0 = 1;</div><div class="line">  <span class="keywordtype">double</span> p1 = x;</div><div class="line"> </div><div class="line">  <span class="keywordtype">double</span> pp0 = 1;</div><div class="line">  <span class="keywordtype">double</span> pp1 = y;</div><div class="line">  <span class="keywordtype">double</span> q0 = 1-y;</div><div class="line">  </div><div class="line">  <span class="keywordtype">double</span> result = (h[0] - h[N]) * q0 * p0;</div><div class="line">  <span class="keywordtype">double</span> c = 0.0; <span class="comment">// compensation for low-order bits</span></div><div class="line">  </div><div class="line">  <span class="keywordtype">double</span> pp2, q1, p2, input, t, z;</div><div class="line">  </div><div class="line">  <span class="keywordflow">for</span>( <span class="keywordtype">int</span> n = 1; n &lt; N; n++ ) {</div><div class="line">    pp2 = ((2*n+1)*y*pp1 - n*pp0)/(n+1);</div><div class="line">    q1 = (pp0 - pp2)/(2*n+1);</div><div class="line">    pp0 = pp1;</div><div class="line">    pp1 = pp2;</div><div class="line"></div><div class="line">    input = (h[n] - h[N]) * q1 * p1;</div><div class="line"></div><div class="line">    z = input - c;</div><div class="line">    t = result + z;</div><div class="line">    c = (t - result) - z;</div><div class="line">    result = t;</div><div class="line"></div><div class="line">    p2 = ((2*n+1)*x*p1 - n*p0)/(n+1);</div><div class="line">    p0 = p1;</div><div class="line">    p1 = p2;</div><div class="line">  }</div><div class="line">  </div><div class="line">  <span class="keywordflow">return</span> core + result;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">double</span> uu_kahan(<span class="keywordtype">double</span> alpha, <span class="keywordtype">double</span> theta) {</div><div class="line">  <span class="keywordtype">double</span> x = cos(theta);</div><div class="line">  <span class="keywordtype">double</span> y = cos(alpha);</div><div class="line">    </div><div class="line">  <span class="keywordtype">double</span> p0 = 1;</div><div class="line">  <span class="keywordtype">double</span> p1 = x;</div><div class="line"> </div><div class="line">  <span class="keywordtype">double</span> pp0 = 1;</div><div class="line">  <span class="keywordtype">double</span> pp1 = y;</div><div class="line">  <span class="keywordtype">double</span> q0 = 1-y;</div><div class="line">  </div><div class="line">  <span class="keywordtype">double</span> result = h[0] * q0 * p0;</div><div class="line">  <span class="keywordtype">double</span> c = 0.0; <span class="comment">// compensation for low-order bits</span></div><div class="line">  </div><div class="line">  <span class="keywordtype">double</span> pp2, q1, p2, input, t, z;</div><div class="line">  </div><div class="line">  <span class="keywordflow">for</span>( <span class="keywordtype">int</span> n = 1; n &lt; 4000000; n++ ) {</div><div class="line">    pp2 = ((2*n+1)*y*pp1 - n*pp0)/(n+1);</div><div class="line">    q1 = (pp0 - pp2)/(2*n+1);</div><div class="line">    pp0 = pp1;</div><div class="line">    pp1 = pp2;</div><div class="line"></div><div class="line">    input = h[40000] * q1 * p1;</div><div class="line">    <span class="keywordflow">if</span> (n &lt;= 40000)</div><div class="line">      input = h[n] * q1 * p1;</div><div class="line"></div><div class="line">    z = input - c;</div><div class="line">    t = result + z;</div><div class="line">    c = (t - result) - z;</div><div class="line">    result = t;</div><div class="line"></div><div class="line">    p2 = ((2*n+1)*x*p1 - n*p0)/(n+1);</div><div class="line">    p0 = p1;</div><div class="line">    p1 = p2;</div><div class="line">  }</div><div class="line">  </div><div class="line">  <span class="keywordflow">return</span> result;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">double</span> uu_kahan_to_n(<span class="keywordtype">double</span> alpha, <span class="keywordtype">double</span> theta, <span class="keywordtype">int</span> M) {</div><div class="line">  <span class="keywordtype">double</span> x = cos(theta);</div><div class="line">  <span class="keywordtype">double</span> y = cos(alpha);</div><div class="line">    </div><div class="line">  <span class="keywordtype">double</span> p0 = 1;</div><div class="line">  <span class="keywordtype">double</span> p1 = x;</div><div class="line"> </div><div class="line">  <span class="keywordtype">double</span> pp0 = 1;</div><div class="line">  <span class="keywordtype">double</span> pp1 = y;</div><div class="line">  <span class="keywordtype">double</span> q0 = 1-y;</div><div class="line">  </div><div class="line">  <span class="keywordtype">double</span> result = h[0] * q0 * p0;</div><div class="line">  <span class="keywordtype">double</span> c = 0.0; <span class="comment">// compensation for low-order bits</span></div><div class="line">  </div><div class="line">  <span class="keywordtype">double</span> pp2, q1, p2, input, t, z;</div><div class="line">  </div><div class="line">  <span class="keywordflow">for</span>( <span class="keywordtype">int</span> n = 1; n &lt; M; n++ ) {</div><div class="line">    pp2 = ((2*n+1)*y*pp1 - n*pp0)/(n+1);</div><div class="line">    q1 = (pp0 - pp2)/(2*n+1);</div><div class="line">    pp0 = pp1;</div><div class="line">    pp1 = pp2;</div><div class="line"></div><div class="line">    input = h[40000] * q1 * p1;</div><div class="line">    <span class="keywordflow">if</span> (n &lt;= 40000)</div><div class="line">      input = h[n] * q1 * p1;</div><div class="line"></div><div class="line">    z = input - c;</div><div class="line">    t = result + z;</div><div class="line">    c = (t - result) - z;</div><div class="line">    result = t;</div><div class="line"></div><div class="line">    p2 = ((2*n+1)*x*p1 - n*p0)/(n+1);</div><div class="line">    p0 = p1;</div><div class="line">    p1 = p2;</div><div class="line">  }</div><div class="line">  </div><div class="line">  <span class="keywordflow">return</span> result;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">double</span> uu_terms_needed(<span class="keywordtype">double</span> alpha, <span class="keywordtype">double</span> theta, <span class="keywordtype">double</span> goal, <span class="keywordtype">double</span> epsilon) {</div><div class="line">  <span class="keywordtype">double</span> x = cos(theta);</div><div class="line">  <span class="keywordtype">double</span> y = cos(alpha);</div><div class="line">    </div><div class="line">  <span class="keywordtype">double</span> p0 = 1;</div><div class="line">  <span class="keywordtype">double</span> p1 = x;</div><div class="line"> </div><div class="line">  <span class="keywordtype">double</span> pp0 = 1;</div><div class="line">  <span class="keywordtype">double</span> pp1 = y;</div><div class="line">  <span class="keywordtype">double</span> q0 = 1-y;</div><div class="line">  </div><div class="line">  <span class="keywordtype">double</span> result = h[0] * q0 * p0;</div><div class="line">  <span class="keywordtype">double</span> c = 0.0; <span class="comment">// compensation for low-order bits</span></div><div class="line">  </div><div class="line">  <span class="keywordtype">double</span> pp2, q1, p2, input, t, z;</div><div class="line">  </div><div class="line">  <span class="keywordflow">for</span>( <span class="keywordtype">int</span> n = 1; n &lt; 4000000; n++ ) {</div><div class="line">    pp2 = ((2*n+1)*y*pp1 - n*pp0)/(n+1);</div><div class="line">    q1 = (pp0 - pp2)/(2*n+1);</div><div class="line">    pp0 = pp1;</div><div class="line">    pp1 = pp2;</div><div class="line"></div><div class="line">    input = h[40000] * q1 * p1;</div><div class="line">    <span class="keywordflow">if</span> (n &lt;= 40000)</div><div class="line">      input = h[n] * q1 * p1;</div><div class="line"></div><div class="line">    z = input - c;</div><div class="line">    t = result + z;</div><div class="line">    c = (t - result) - z;</div><div class="line">    result = t;</div><div class="line"></div><div class="line">    p2 = ((2*n+1)*x*p1 - n*p0)/(n+1);</div><div class="line">    p0 = p1;</div><div class="line">    p1 = p2;</div><div class="line">    </div><div class="line">    <span class="keywordflow">if</span> (fabs(result - goal) &lt; epsilon)</div><div class="line">      <span class="keywordflow">return</span> n;</div><div class="line">  }</div><div class="line">  </div><div class="line">  <span class="keywordflow">return</span> -1;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">double</span> hyperg_z_GT1 (<span class="keywordtype">double</span> a, <span class="keywordtype">double</span> b, <span class="keywordtype">double</span> c, <span class="keywordtype">double</span> z) {</div><div class="line">  <span class="keywordtype">double</span> coef1,coef2;</div><div class="line">  coef1=gsl_sf_gamma(c)*gsl_sf_gamma(b-a)*pow(1-z,-a)/(gsl_sf_gamma(b)*gsl_sf_gamma(c-a));</div><div class="line">  coef2=gsl_sf_gamma(c)*gsl_sf_gamma(a-b)*pow(1-z,-b)/(gsl_sf_gamma(a)*gsl_sf_gamma(c-b));</div><div class="line">  <span class="keywordtype">double</span> result = coef1*gsl_sf_hyperg_2F1(a,c-b,a-b+1,1/(1-z))+coef2*gsl_sf_hyperg_2F1(b,c-a,b-a+1,1/(1-z));</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> result;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">double</span> f (<span class="keywordtype">double</span> t, <span class="keywordtype">void</span> *params)</div><div class="line">{</div><div class="line">  <span class="keywordtype">double</span> y = *(<span class="keywordtype">double</span> *) params;</div><div class="line">  <span class="keywordtype">double</span> z = (1-t*t)*(1-y*y)/((1-t*y)*(1-t*y));</div><div class="line"></div><div class="line">  <span class="comment">// BADBAD: this is broken</span></div><div class="line">  <span class="keywordflow">if</span> (fabs(z - 1.0) &lt; 1e-10)</div><div class="line">    z = 1.0 - 1e-10;</div><div class="line">  </div><div class="line">  <span class="keywordflow">if</span> ((z &lt; -1) || (z &gt; 1))</div><div class="line">    <span class="keywordflow">return</span> hyperg_z_GT1(0.25, 0.75, 1.0, z)/sqrt(2-2*t*y);</div><div class="line">  <span class="keywordflow">else</span></div><div class="line">    <span class="keywordflow">return</span> gsl_sf_hyperg_2F1(0.25, 0.75, 1.0, z)/sqrt(2-2*t*y);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">double</span> G(<span class="keywordtype">double</span> x,<span class="keywordtype">double</span> y) {</div><div class="line">  gsl_integration_workspace *work_ptr = gsl_integration_workspace_alloc (10000);</div><div class="line"></div><div class="line">  <span class="keywordtype">double</span> lower_limit = x;   <span class="comment">/* lower limit a */</span></div><div class="line">  <span class="keywordtype">double</span> upper_limit = 1;   <span class="comment">/* upper limit b */</span></div><div class="line">  <span class="keywordtype">double</span> abs_error = 1.0e-6;    <span class="comment">/* to avoid round-off problems */</span></div><div class="line">  <span class="keywordtype">double</span> rel_error = 1.0e-6;    <span class="comment">/* the result will usually be much better */</span></div><div class="line">  <span class="keywordtype">double</span> result;        <span class="comment">/* the result from the integration */</span></div><div class="line">  <span class="keywordtype">double</span> error;         <span class="comment">/* the estimated error from the integration */</span></div><div class="line"></div><div class="line">  <span class="keywordtype">double</span> alpha = 1.0;       <span class="comment">// parameter in integrand</span></div><div class="line">  <span class="keywordtype">double</span> expected = -4.0;   <span class="comment">// exact answer</span></div><div class="line"></div><div class="line">  gsl_function My_function;</div><div class="line">  <span class="keywordtype">void</span> *params_ptr = &amp;y;</div><div class="line">  My_function.function = &amp;f;</div><div class="line">  My_function.params = params_ptr;</div><div class="line"></div><div class="line">  </div><div class="line">  <span class="keywordtype">double</span> pts[3];</div><div class="line">  <span class="keywordtype">int</span> npts;</div><div class="line"></div><div class="line">  <span class="keywordflow">if</span> ((y &gt; x) &amp;&amp; (y &lt; 1)) {</div><div class="line">    pts[0] = lower_limit;</div><div class="line">    pts[1] = y;</div><div class="line">    pts[2] = upper_limit;</div><div class="line">    npts = 3;</div><div class="line">  } <span class="keywordflow">else</span> {</div><div class="line">    pts[0] = lower_limit;</div><div class="line">    pts[1] = upper_limit;</div><div class="line">    npts = 2;    </div><div class="line">  }</div><div class="line"></div><div class="line">  gsl_integration_qagp (&amp;My_function, pts, npts,</div><div class="line">            abs_error, rel_error, 1000, work_ptr, &amp;result,</div><div class="line">            &amp;error);</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> result;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">double</span> uu_combined(<span class="keywordtype">double</span> alpha, <span class="keywordtype">double</span> theta) {</div><div class="line">  <span class="keywordtype">double</span> x = cos(theta);</div><div class="line">  <span class="keywordtype">double</span> y = cos(alpha);</div><div class="line"><span class="preprocessor">#define N 40000</span></div><div class="line">  <span class="keywordtype">double</span> core = h[N] * G(y,x);</div><div class="line"></div><div class="line">  <span class="keywordtype">double</span> p0 = 1;</div><div class="line">  <span class="keywordtype">double</span> p1 = x;</div><div class="line"> </div><div class="line">  <span class="keywordtype">double</span> pp0 = 1;</div><div class="line">  <span class="keywordtype">double</span> pp1 = y;</div><div class="line">  <span class="keywordtype">double</span> q0 = 1-y;</div><div class="line">  </div><div class="line">  <span class="keywordtype">double</span> result = (h[0] - h[N]) * q0 * p0;</div><div class="line">  <span class="keywordtype">double</span> c = 0.0; <span class="comment">// compensation for low-order bits</span></div><div class="line">  </div><div class="line">  <span class="keywordtype">double</span> pp2, q1, p2, input, t, z;</div><div class="line">  </div><div class="line">  <span class="keywordflow">for</span>( <span class="keywordtype">int</span> n = 1; n &lt; N; n++ ) {</div><div class="line">    pp2 = ((2*n+1)*y*pp1 - n*pp0)/(n+1);</div><div class="line">    q1 = (pp0 - pp2)/(2*n+1);</div><div class="line">    pp0 = pp1;</div><div class="line">    pp1 = pp2;</div><div class="line"></div><div class="line">    input = (h[n] - h[N]) * q1 * p1;</div><div class="line"></div><div class="line">    z = input - c;</div><div class="line">    t = result + z;</div><div class="line">    c = (t - result) - z;</div><div class="line">    result = t;</div><div class="line"></div><div class="line">    p2 = ((2*n+1)*x*p1 - n*p0)/(n+1);</div><div class="line">    p0 = p1;</div><div class="line">    p1 = p2;</div><div class="line">  }</div><div class="line">  </div><div class="line">  <span class="keywordflow">return</span> core + result;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">double</span> uu_combined_to_n(<span class="keywordtype">double</span> alpha, <span class="keywordtype">double</span> theta, <span class="keywordtype">int</span> M) {</div><div class="line">  <span class="keywordtype">double</span> x = cos(theta);</div><div class="line">  <span class="keywordtype">double</span> y = cos(alpha);</div><div class="line">  <span class="keywordtype">double</span> core = h[40000] * G(y,x);</div><div class="line"></div><div class="line">  <span class="keywordtype">double</span> p0 = 1;</div><div class="line">  <span class="keywordtype">double</span> p1 = x;</div><div class="line"> </div><div class="line">  <span class="keywordtype">double</span> pp0 = 1;</div><div class="line">  <span class="keywordtype">double</span> pp1 = y;</div><div class="line">  <span class="keywordtype">double</span> q0 = 1-y;</div><div class="line">  </div><div class="line">  <span class="keywordtype">double</span> result = (h[0] - h[40000]) * q0 * p0;</div><div class="line">  <span class="keywordtype">double</span> c = 0.0; <span class="comment">// compensation for low-order bits</span></div><div class="line">  </div><div class="line">  <span class="keywordtype">double</span> pp2, q1, p2, input, t, z;</div><div class="line">  </div><div class="line">  <span class="keywordflow">for</span>( <span class="keywordtype">int</span> n = 1; n &lt; M; n++ ) {</div><div class="line">    pp2 = ((2*n+1)*y*pp1 - n*pp0)/(n+1);</div><div class="line">    q1 = (pp0 - pp2)/(2*n+1);</div><div class="line">    pp0 = pp1;</div><div class="line">    pp1 = pp2;</div><div class="line"></div><div class="line">    input = (h[n] - h[40000]) * q1 * p1;</div><div class="line"></div><div class="line">    z = input - c;</div><div class="line">    t = result + z;</div><div class="line">    c = (t - result) - z;</div><div class="line">    result = t;</div><div class="line"></div><div class="line">    p2 = ((2*n+1)*x*p1 - n*p0)/(n+1);</div><div class="line">    p0 = p1;</div><div class="line">    p1 = p2;</div><div class="line">  }</div><div class="line">  </div><div class="line">  <span class="keywordflow">return</span> core + result;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/****************************************************************/</span></div><div class="line"><span class="comment">/* Load the love numbers */</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span></div><div class="line">main (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">  load_love_numbers();</div><div class="line">  </div><div class="line">  clock_t begin = clock();</div><div class="line"></div><div class="line">  <span class="keywordtype">double</span> degrees = M_PI / 180.0;</div><div class="line">  <span class="keywordtype">double</span> x = 0.1*degrees, y;</div><div class="line"></div><div class="line">  <span class="keywordflow">for</span>( y=x/4.0; y&lt;2*x; y=y+(x/200.0)) {</div><div class="line">    <span class="keywordtype">double</span> combined = uu_combined(x,y);</div><div class="line">    <span class="keywordtype">double</span> d = uu_spherical(x,y); </div><div class="line">    <span class="comment">//double combined_bad = uu_combined_to_n(x,y,400);    </span></div><div class="line">    <span class="comment">//double kahan_big = uu_kahan_to_n(x,y, 4000000);</span></div><div class="line">    <span class="comment">//double kahan = uu_kahan(x,y);</span></div><div class="line">    <span class="comment">//double kahan = uu_kahan_to_n(x,y,400000);</span></div><div class="line">    <span class="comment">//double kahan_bad = uu_kahan_to_n(x,y, 4000);</span></div><div class="line">    <span class="comment">//double kahan_maybe = uu_kahan_to_n(x,y, 40000);</span></div><div class="line">    <span class="comment">//double kahan_really_bad = uu_kahan_to_n(x,y, 400);        </span></div><div class="line">    <span class="comment">//printf (&quot;%e %e %e (err %e)\n&quot;, y/x, combined, kahan, fabs(combined-kahan) );</span></div><div class="line">    <span class="comment">//int n = uu_terms_needed(x, y, combined, 1e-8);</span></div><div class="line">    <span class="comment">//printf (&quot;%e %e %e %e\n&quot;, y/x, combined, combined_bad, combined-combined_bad );</span></div><div class="line">    <span class="comment">//printf (&quot;%e %e %e %e\n&quot;, y/x, kahan, d, (kahan - d)/kahan );</span></div><div class="line">    <span class="comment">//printf (&quot;%e %e %e %e\n&quot;, y/x, kahan, combined, (kahan - combined)/kahan );</span></div><div class="line">    printf (<span class="stringliteral">&quot;%e %e %e %e\n&quot;</span>, x, y, combined, d/combined );</div><div class="line">  }</div><div class="line"></div><div class="line">  clock_t end = clock();</div><div class="line">  <span class="keywordtype">double</span> time_spent = (double)(end - begin) / CLOCKS_PER_SEC;</div><div class="line">  printf( <span class="stringliteral">&quot;%e seconds&quot;</span>, time_spent );</div><div class="line">  </div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
